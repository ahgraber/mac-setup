---
- shell: pwd
  register: shell_pwd
  when: debug

- debug: var=shell_pwd.stdout
  when: debug

- name: Ensure VSCode User directory exists.
  file:
    path: "/Users/{{ lookup('env', 'USER') }}/Library/Application Support/Code/User"
    owner: "{{ lookup('env', 'USER') }}"
    # group: "{{ homebrew_group }}"
    state: directory
    mode: 0755
  become: true

- name: Copy VSCode configuration
  copy:
    src: files/vscode/settings.json
    dest: /Users/{{ lookup('env', 'USER') }}/Library/Application Support/Code/User/settings.json
    owner: "{{ lookup('env', 'USER') }}"
    force: no

- name: Copy VSCode keybinding
  copy:
    src: files/vscode/keybindings.json
    dest: /Users/{{ lookup('env', 'USER') }}/Library/Application Support/Code/User/keybindings.json
    owner: "{{ lookup('env', 'USER') }}"
    force: no

- name: Install VSCode extensions
  shell: code --install-extension {{ item }}
  with_items: "{{ vscode_extensions }}"

- name: Add MaterialDarker theme to iTerm
  shell: |
    # check for `MaterialDarker` as key
    test="$(plutil -extract 'Custom Color Presets.MaterialDarker' xml1 -o - ~/Library/Preferences/com.googlecode.iterm2.plist)"
    match="No value at that key path or invalid key path"
    if [[ "$test" =~ "$match" ]]; then
      action="insert"
    else
      action="replace"
    fi
    plutil -$action "Custom Color Presets.MaterialDarker" -json '{
      "Ansi 0 Color": {
        "Alpha Component": 1,
        "Blue Component": 0.1726332306861877,
        "Color Space": "sRGB",
        "Green Component": 0.172635942697525,
        "Red Component": 0.1726308763027191
      },
      "Ansi 1 Color": {
        "Alpha Component": 1,
        "Blue Component": 0.1568627059459686,
        "Color Space": "sRGB",
        "Green Component": 0.1568626761436462,
        "Red Component": 0.7764706015586853
      },
      "Ansi 2 Color": {
        "Alpha Component": 1,
        "Blue Component": 0,
        "Color Space": "sRGB",
        "Green Component": 0.7058823704719543,
        "Red Component": 0
      },
      "Ansi 3 Color": {
        "Alpha Component": 1,
        "Blue Component": 0.1450980007648468,
        "Color Space": "sRGB",
        "Green Component": 0.658823549747467,
        "Red Component": 0.9764706492424011
      },
      "Ansi 4 Color": {
        "Alpha Component": 1,
        "Blue Component": 0.7529410719871521,
        "Color Space": "sRGB",
        "Green Component": 0.3960783779621124,
        "Red Component": 0.08235301822423935
      },
      "Ansi 5 Color": {
        "Alpha Component": 1,
        "Blue Component": 0.603918731212616,
        "Color Space": "sRGB",
        "Green Component": 0.1189841404557228,
        "Red Component": 0.415599912405014
      },
      "Ansi 6 Color": {
        "Alpha Component": 1,
        "Blue Component": 0.5607842803001404,
        "Color Space": "sRGB",
        "Green Component": 0.5137254595756531,
        "Red Component": 1.628173009748934e-7
      },
      "Ansi 7 Color": {
        "Alpha Component": 1,
        "Blue Component": 0.9490196108818054,
        "Color Space": "sRGB",
        "Green Component": 0.9490196108818054,
        "Red Component": 0.949019730091095
      },
      "Ansi 8 Color": {
        "Alpha Component": 1,
        "Blue Component": 0.327831894159317,
        "Color Space": "sRGB",
        "Green Component": 0.3278364539146423,
        "Red Component": 0.3278279900550842
      },
      "Ansi 9 Color": {
        "Alpha Component": 1,
        "Blue Component": 0.3137254118919373,
        "Color Space": "sRGB",
        "Green Component": 0.3254901170730591,
        "Red Component": 0.9372549057006836
      },
      "Ansi 10 Color": {
        "Alpha Component": 1,
        "Blue Component": 0,
        "Color Space": "sRGB",
        "Green Component": 0.843137264251709,
        "Red Component": 0
      },
      "Ansi 11 Color": {
        "Alpha Component": 1,
        "Blue Component": 0.2313724458217621,
        "Color Space": "sRGB",
        "Green Component": 0.9215685725212097,
        "Red Component": 1
      },
      "Ansi 12 Color": {
        "Alpha Component": 1,
        "Blue Component": 0.9647058844566345,
        "Color Space": "sRGB",
        "Green Component": 0.7098039984703064,
        "Red Component": 0.3921568989753723
      },
      "Ansi 13 Color": {
        "Alpha Component": 1,
        "Blue Component": 0.7843137383460999,
        "Color Space": "sRGB",
        "Green Component": 0.4078430831432343,
        "Red Component": 0.7294119000434875
      },
      "Ansi 14 Color": {
        "Alpha Component": 1,
        "Blue Component": 0.8549019694328308,
        "Color Space": "sRGB",
        "Green Component": 0.7764706015586853,
        "Red Component": 0.1490196585655212
      },
      "Ansi 15 Color": {
        "Alpha Component": 1,
        "Blue Component": 0.8784313797950745,
        "Color Space": "sRGB",
        "Green Component": 0.8784313797950745,
        "Red Component": 0.878431499004364
      },
      "Background Color": {
        "Alpha Component": 1,
        "Blue Component": 0.1294117718935013,
        "Color Space": "sRGB",
        "Green Component": 0.1294117718935013,
        "Red Component": 0.1294117718935013
      },
      "Badge Color": {
        "Alpha Component": 0.5,
        "Blue Component": 0,
        "Color Space": "sRGB",
        "Green Component": 0.1491314172744751,
        "Red Component": 1
      },
      "Bold Color": {
        "Alpha Component": 1,
        "Blue Component": 0.1568627059459686,
        "Color Space": "sRGB",
        "Green Component": 0.1568626761436462,
        "Red Component": 0.7764706015586853
      },
      "Cursor Color": {
        "Alpha Component": 1,
        "Blue Component": 0.8823529481887817,
        "Color Space": "sRGB",
        "Green Component": 0.1000000014901161,
        "Red Component": 0.8823529481887817
      },
      "Cursor Guide Color": {
        "Alpha Component": 0.25,
        "Blue Component": 1,
        "Color Space": "sRGB",
        "Green Component": 0.9268307089805603,
        "Red Component": 0.7021318674087524
      },
      "Cursor Text Color": {
        "Alpha Component": 1,
        "Blue Component": 0.8980391621589661,
        "Color Space": "sRGB",
        "Green Component": 0.8980392813682556,
        "Red Component": 0.8980392813682556
      },
      "Foreground Color": {
        "Alpha Component": 1,
        "Blue Component": 0.9176470041275024,
        "Color Space": "sRGB",
        "Green Component": 0.9176470637321472,
        "Red Component": 0.9176470637321472
      },
      "Link Color": {
        "Alpha Component": 1,
        "Blue Component": 0.734233021736145,
        "Color Space": "sRGB",
        "Green Component": 0.3591606020927429,
        "Red Component": 0
      },
      "Selected Text Color": {
        "Alpha Component": 1,
        "Blue Component": 0.3058823347091675,
        "Color Space": "sRGB",
        "Green Component": 0.3058823347091675,
        "Red Component": 0.3058823347091675
      },
      "Selection Color": {
        "Alpha Component": 1,
        "Blue Component": 0.8980391621589661,
        "Color Space": "sRGB",
        "Green Component": 0.8980392813682556,
        "Red Component": 0.8980392813682556
      },
      "Tab Color": {
        "Alpha Component": 1,
        "Blue Component": 0.3215686082839966,
        "Color Space": "sRGB",
        "Green Component": 0.258823573589325,
        "Red Component": 0.2313725650310516
      },
      "Underline Color": {
        "Alpha Component": 1,
        "Blue Component": 0.5069419741630554,
        "Color Space": "sRGB",
        "Green Component": 0.3795028030872345,
        "Red Component": 0.3489385843276978
      }
    }' ~/Library/Preferences/com.googlecode.iterm2.plist


- name: Apply default settings to iTerm profile
  shell: |
    plutil -replace "New Bookmarks.0.Ansi 0 Color" -json '{
      "Alpha Component": 1,
      "Blue Component": 0.1726332306861877,
      "Color Space": "sRGB",
      "Green Component": 0.172635942697525,
      "Red Component": 0.1726308763027191
    }' ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Ansi 1 Color" -json '{
      "Alpha Component": 1,
      "Blue Component": 0.1568627059459686,
      "Color Space": "sRGB",
      "Green Component": 0.1568626761436462,
      "Red Component": 0.7764706015586853
    }' ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Ansi 2 Color" -json '{
      "Alpha Component": 1,
      "Blue Component": 0,
      "Color Space": "sRGB",
      "Green Component": 0.7058823704719543,
      "Red Component": 0
    }' ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Ansi 3 Color" -json '{
      "Alpha Component": 1,
      "Blue Component": 0.1450980007648468,
      "Color Space": "sRGB",
      "Green Component": 0.658823549747467,
      "Red Component": 0.9764706492424011
    }' ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Ansi 4 Color" -json '{
      "Alpha Component": 1,
      "Blue Component": 0.7529410719871521,
      "Color Space": "sRGB",
      "Green Component": 0.3960783779621124,
      "Red Component": 0.08235301822423935
    }' ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Ansi 5 Color" -json '{
      "Alpha Component": 1,
      "Blue Component": 0.603918731212616,
      "Color Space": "sRGB",
      "Green Component": 0.1189841404557228,
      "Red Component": 0.415599912405014
    }' ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Ansi 6 Color" -json '{
      "Alpha Component": 1,
      "Blue Component": 0.5607842803001404,
      "Color Space": "sRGB",
      "Green Component": 0.5137254595756531,
      "Red Component": 1.628173009748934e-7
    }' ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Ansi 7 Color" -json '{
      "Alpha Component": 1,
      "Blue Component": 0.9490196108818054,
      "Color Space": "sRGB",
      "Green Component": 0.9490196108818054,
      "Red Component": 0.949019730091095
    }' ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Ansi 8 Color" -json '{
      "Alpha Component": 1,
      "Blue Component": 0.327831894159317,
      "Color Space": "sRGB",
      "Green Component": 0.3278364539146423,
      "Red Component": 0.3278279900550842
    }' ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Ansi 9 Color" -json '{
      "Alpha Component": 1,
      "Blue Component": 0.3137254118919373,
      "Color Space": "sRGB",
      "Green Component": 0.3254901170730591,
      "Red Component": 0.9372549057006836
    }' ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Ansi 10 Color" -json '{
      "Alpha Component": 1,
      "Blue Component": 0,
      "Color Space": "sRGB",
      "Green Component": 0.843137264251709,
      "Red Component": 0
    }' ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Ansi 11 Color" -json '{
      "Alpha Component": 1,
      "Blue Component": 0.2313724458217621,
      "Color Space": "sRGB",
      "Green Component": 0.9215685725212097,
      "Red Component": 1
    }' ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Ansi 12 Color" -json '{
      "Alpha Component": 1,
      "Blue Component": 0.9647058844566345,
      "Color Space": "sRGB",
      "Green Component": 0.7098039984703064,
      "Red Component": 0.3921568989753723
    }' ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Ansi 13 Color" -json '{
      "Alpha Component": 1,
      "Blue Component": 0.7843137383460999,
      "Color Space": "sRGB",
      "Green Component": 0.4078430831432343,
      "Red Component": 0.7294119000434875
    }' ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Ansi 14 Color" -json '{
      "Alpha Component": 1,
      "Blue Component": 0.8549019694328308,
      "Color Space": "sRGB",
      "Green Component": 0.7764706015586853,
      "Red Component": 0.1490196585655212
    }' ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Ansi 15 Color" -json '{
      "Alpha Component": 1,
      "Blue Component": 0.8784313797950745,
      "Color Space": "sRGB",
      "Green Component": 0.8784313797950745,
      "Red Component": 0.878431499004364
    }' ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Background Color" -json '{
      "Alpha Component": 1,
      "Blue Component": 0.1294117718935013,
      "Color Space": "sRGB",
      "Green Component": 0.1294117718935013,
      "Red Component": 0.1294117718935013
    }' ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Badge Color" -json '{
      "Alpha Component": 0.5,
      "Blue Component": 0,
      "Color Space": "sRGB",
      "Green Component": 0.1491314172744751,
      "Red Component": 1
    }' ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Bold Color" -json '{
      "Alpha Component": 1,
      "Blue Component": 0.1568627059459686,
      "Color Space": "sRGB",
      "Green Component": 0.1568626761436462,
      "Red Component": 0.7764706015586853
    }' ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Cursor Color" -json '{
      "Alpha Component": 1,
      "Blue Component": 0.8823529481887817,
      "Color Space": "sRGB",
      "Green Component": 0.1000000014901161,
      "Red Component": 0.8823529481887817
    }' ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Cursor Guide Color" -json '{
      "Alpha Component": 0.25,
      "Blue Component": 1,
      "Color Space": "sRGB",
      "Green Component": 0.9268307089805603,
      "Red Component": 0.7021318674087524
    }' ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Cursor Text Color" -json '{
      "Alpha Component": 1,
      "Blue Component": 0.8980391621589661,
      "Color Space": "sRGB",
      "Green Component": 0.8980392813682556,
      "Red Component": 0.8980392813682556
    }' ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Foreground Color" -json '{
      "Alpha Component": 1,
      "Blue Component": 0.9176470041275024,
      "Color Space": "sRGB",
      "Green Component": 0.9176470637321472,
      "Red Component": 0.9176470637321472
    }' ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Link Color" -json '{
      "Alpha Component": 1,
      "Blue Component": 0.734233021736145,
      "Color Space": "sRGB",
      "Green Component": 0.3591606020927429,
      "Red Component": 0
    }' ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Selected Text Color" -json '{
      "Alpha Component": 1,
      "Blue Component": 0.3058823347091675,
      "Color Space": "sRGB",
      "Green Component": 0.3058823347091675,
      "Red Component": 0.3058823347091675
    }' ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Selection Color" -json '{
      "Alpha Component": 1,
      "Blue Component": 0.8980391621589661,
      "Color Space": "sRGB",
      "Green Component": 0.8980392813682556,
      "Red Component": 0.8980392813682556
    }' ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Tab Color" -json '{
      "Alpha Component": 1,
      "Blue Component": 0.3215686082839966,
      "Color Space": "sRGB",
      "Green Component": 0.258823573589325,
      "Red Component": 0.2313725650310516
    }' ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Underline Color" -json '{
      "Alpha Component": 1,
      "Blue Component": 0.5069419741630554,
      "Color Space": "sRGB",
      "Green Component": 0.3795028030872345,
      "Red Component": 0.3489385843276978
    }' ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.ASCII Anti Aliased" -integer 1 ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.ASCII Ligatures" -integer 1 ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Character Encoding" -integer 4 ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Columns" -integer 120 ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Rows" -integer 25 ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Draw Powerline Glyphs" -integer 1 ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Horizontal Spacing" -integer 1 ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Vertical Spacing" -integer 1 ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Non Ascii Font" -string "MesloLGS-NF-Regular 16" ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Non-ASCII Anti Aliased" -integer 1 ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Non-ASCII Ligatures" -integer 1 ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Normal Font" -string "MesloLGS-NF-Regular 13" ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Use Bold Font" -integer 1 ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Use Bright Bold" -integer 1 ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Use Italic Font" -integer 1 ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Use Non-ASCII Font" -integer 1 ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Unlimited Scrollback" -integer 1 ~/Library/Preferences/com.googlecode.iterm2.plist
    plutil -replace "New Bookmarks.0.Working Directory" -string "~" ~/Library/Preferences/com.googlecode.iterm2.plist


# - name: Ensure iTerm dynamicprofiles directory exists.
#   file:
#     path: "/Users/{{ lookup('env', 'USER') }}/Library/Application Support/iTerm2/DynamicProfiles"
#     owner: "{{ lookup('env', 'USER') }}"
#     # group: "{{ homebrew_group }}"
#     state: directory
#     mode: 0755
#   become: true

# - name: Copy iTerm profile
#   copy:
#     src: files/iterm/Dynamic.json
#     dest: /Users/{{ lookup('env', 'USER') }}/Library/Application Support/iTerm2/DynamicProfiles/Dynamic.json
#     owner: "{{ lookup('env', 'USER') }}"
#     force: no

# Custom Terminal theme.
- name: Get current Terminal profile.
  command: defaults read com.apple.terminal 'Default Window Settings'
  register: terminal_theme
  changed_when: false
  check_mode: false

- name: Ensure custom Terminal profile is added.
  command: open files/terminal/MaterialDarker.terminal
  changed_when: false
  when: "'MaterialDarker' not in terminal_theme.stdout"

- name: Ensure custom Terminal profile is set as default.
  command: "{{ item }}"
  with_items:
    - defaults write com.apple.terminal 'Default Window Settings' -string MaterialDarker
    - defaults write com.apple.terminal 'Startup Window Settings' -string MaterialDarker
  changed_when: false
  when: "'MaterialDarker' not in terminal_theme.stdout"

# only if running from remote
# - name: Check if Terminal is Active.
#   shell: ps aux | grep -F 'Terminal' | grep -v -F 'grep' | awk '{ print $2 }'
#   register: terminal_pid
#   changed_when: false

# - name: Restart Terminal if it's running to activate the new profile.
#   shell: |
#     osascript -e 'quit app "Terminal"'
#     open -a Terminal
#   changed_when: false
#   when: terminal_pid.stdout != ""
